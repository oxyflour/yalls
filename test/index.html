<!doctype html>
<html>
<head>
<link rel="stylesheet" href="//cdn.bootcss.com/mocha/2.3.3/mocha.min.css">
</head>
<body>
<div id="mocha"></div>
<script src="../build/index.js"></script>
<script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/mocha/2.3.3/mocha.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/chai/3.3.0/chai.min.js"></script>
<script src="//cdn.bootcss.com/babel-core/5.8.25/browser-polyfill.min.js"></script>
<script>mocha.setup('bdd')</script>
<script type="script/x-lua" id="async">

mkYield = fn(ret)
	next = fn(cc)
		fn(value)
			callcc(fn(rcc)
				ret := rcc
				cc(value)
			end)
		end
	end
	fn(value)
		callcc(fn(cc)
			ret({ next = next(cc), value })
		end)
	end
end

mkGenerator = fn(iter)
	next = fn()
		callcc(fn(cc)
			yield = mkYield(cc)
			iter(yield)
		end)
	end
	fn(value)
		ret = next and next(value)
		next := ret and ret.next
		ret and ret.value
	end
end

doAsync = fn(exec, next)
	next = mkGenerator(fn(yield)
		exec(yield, next)
		-- stop it or the code after doAsync will be executed again
		yield()
	end)
	next()
end

-- used for other scripts
exports = { mkGenerator, doAsync }

</script>
<script>

var loaded = { }

function makeAsyncRequire(file) {
	var dir = file.replace(/[^/]*$/, '')
	return function(file, callback) {
		var path = dir + '/' + file + '.lua'

		if (loaded[path]) setTimeout(function() {
			callback(loaded[path])
		}, 0)
		else $.get(path, function(input) {

			input = [
				'doAsync(fn(yield, next)',
					'require = file => yield(asyncRequire(file, next))',
					'exports = { }',
					input,
					'asyncCallback(exports)',
				'end)',
			].join('\n')

			var tree = yalls.parse(input),
				code = yalls.compile(tree),
				env = yalls.environment(root)

			env('asyncRequire', makeAsyncRequire(path))
			env('asyncCallback', function(mod) {
				loaded[path] = mod
				callback(mod)
			})
			yalls.evaluate(code, env)
		})
	}
}

var root = yalls.environment(null, yalls.buildins)
root('console', console)
root('evaluate', yalls.evaluate)

root('describe', describe)
root('it', it)
root('assert', chai.assert)

var tree = yalls.parse($('#async').text()),
	code = yalls.compile(tree)
yalls.evaluate(code, root)

root('asyncRequire', makeAsyncRequire('./'))('./test', function() {
	mocha.run()
})

</script>
</body>
</html>
